/*
	Copyright Salesforce.com 2015 
	Copyright 2010 Meebo Inc.

	Licensed under the Apache License, Version 2.0 (the "License");
	you may not use this file except in compliance with the License.
	You may obtain a copy of the License at

	    http://www.apache.org/licenses/LICENSE-2.0

	Unless required by applicable law or agreed to in writing, software
	distributed under the License is distributed on an "AS IS" BASIS,
	WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
	See the License for the specific language governing permissions and
	limitations under the License.
*/
varSFIDWidget_loginHandler;varSFIDWidget_logoutHandler;varSFIDWidget=function(){this.config=null;this.access_token=null;this.openid=null;this.openid_response=null;this.win=window;this.unsupported=!(win.postMessage&&win.localStorage&&win.JSON);this.XAuthServerUrl=null;this.iframe=null;this.postWindow=null;this.openRequests={};this.requestId=0;this.requestQueue=[];functionaddButton(targetDiv){targetDiv.innerHTML='';varbutton=document.createElement("button");button.className="sfid-button";button.innerHTML="Log in";button.setAttribute("onClick","SFIDWidget.login()");targetDiv.appendChild(button);}functionaddLogin(targetDiv){if(targetDiv!=null)targetDiv.innerHTML='';varcontent=document.createElement('div');if(SFIDWidget.config.mode=='modal')content.id="sfid-content";elseif(SFIDWidget.config.mode=='inline')content.id="sfid-inline-content";if(SFIDWidget.config.mode=='modal'){if(SFIDWidget.authconfig.LoginPage.LogoUrl!=null){varlogowrapper=document.createElement('div');logowrapper.id="sfid-logo_wrapper";logowrapper.className="sfid-standard_logo_wrapper sfid-mt12";varimg=document.createElement('img');img.src=SFIDWidget.authconfig.LoginPage.LogoUrl;img.className="sfid-standard_logo";logowrapper.appendChild(img);content.appendChild(logowrapper);}}varerror=document.createElement('div');error.className="sfid-mb1";error.id="sfid-error";error.innerHTML="Your login attempt has failed. Make sure the username and password are correct. ";error.style.display="none";content.appendChild(error);if(SFIDWidget.authconfig.LoginPage.UsernamePasswordEnabled){varform=document.createElement('form');form.setAttribute("onSubmit","SFIDWidget.authenticate();return false;");varun=document.createElement('input');un.className="sfid-wide sfid-mb12";un.type="text";un.name="username";un.id="sfid-username";un.setAttribute("placeholder","Username");varpw=document.createElement('input');pw.className="sfid-wide sfid-mb12";pw.type="password";pw.name="password";pw.id="sfid-password";pw.setAttribute("placeholder","Password");varbutton=document.createElement("input");button.className="sfid-button sfid-wide sfid-mb16";button.type="submit";button.id="sfid-submit";button.value="Log in";form.appendChild(un);form.appendChild(pw);form.appendChild(button);content.appendChild(form);}if((SFIDWidget.authconfig.LoginPage.UsernamePasswordEnabled)&&(SFIDWidget.authconfig.AuthProviders.length>0)){varorloginwith=document.createElement("p");orloginwith.className="sfid-small sfid-mb16";orloginwith.innerHTML="or log in with";content.appendChild(orloginwith);}elseif((!SFIDWidget.authconfig.LoginPage.UsernamePasswordEnabled)&&(SFIDWidget.authconfig.AuthProviders.length>0)){varorloginwith=document.createElement("p");orloginwith.className="sfid-small sfid-mb16";orloginwith.innerHTML="Choose a Provider";content.appendChild(orloginwith);}if(SFIDWidget.authconfig.AuthProviders.length>0){varsocial=document.createElement('div');social.id="sfid-social";varsocialul=document.createElement('ul');for(variinSFIDWidget.authconfig.AuthProviders){varsocialli=document.createElement('li');varicon=document.createElement('img');icon.src=SFIDWidget.authconfig.AuthProviders[i].IconUrl;vara=document.createElement('a');a.href=SFIDWidget.authconfig.AuthProviders[i].SsoUrl+'&startURL='+encodeURIComponent(SFIDWidget.config.authorizeURL);a.appendChild(icon);a.title=SFIDWidget.authconfig.AuthProviders[i].Name;socialli.appendChild(a);socialul.appendChild(socialli);}social.appendChild(socialul);content.appendChild(social);}if(SFIDWidget.config.mode=='modal'){varlightbox=document.createElement('div');lightbox.className="sfid-lightbox";lightbox.id="sfid-login-overlay";lightbox.setAttribute("onClick","SFIDWidget.cancel()");varwrapper=document.createElement('div');wrapper.id="sfid-wrapper";wrapper.onclick=function(event){event=event||window.eventif(event.stopPropagation){event.stopPropagation()}else{event.cancelBubble=true}}wrapper.appendChild(content);lightbox.appendChild(wrapper);document.body.appendChild(lightbox);}else{targetDiv.appendChild(content);}}functioncloseLogin(){varlightbox=document.getElementById("sfid-login-overlay");lightbox.style.display="none";if(lightbox.parentNode){lightbox.parentNode.removeChild(lightbox);}}functiononMessage(event){varoriginHostname=event.origin.split(':if(originHostname!=SFIDWidget.config.domain){console.log('doesntmatchdomain:'+originHostname+";"+SFIDWidget.config.domain);return;}varmsg=JSON.parse(event.data);if(!msg){return;}if(msg.cmd=='xauth::ready'){postWindow=iframe.contentWindow;setTimeout(makePendingRequests,0);return;}varrequest=openRequests[msg.id];if(request){if(request.callback){request.callback(msg);}deleteopenRequests[msg.id];}}functionsetupWindow(){if(iframe||postWindow){return;}vardoc=win.document;iframe=doc.createElement('iframe');iframe.id='sfid_xdomain';variframeStyle=iframe.style;iframeStyle.position='absolute';iframeStyle.left=iframeStyle.top='-999px';if(win.addEventListener){win.addEventListener('message',onMessage,false);}elseif(win.attachEvent){win.attachEvent('onmessage',onMessage);}doc.body.appendChild(iframe);iframe.src=SFIDWidget.XAuthServerUrl;}functionmakePendingRequests(){for(vari=0;i<requestQueue.length;i++){makeRequest(openRequests[requestQueue.shift()]);}}functionmakeRequest(requestObj){console.log(document.getElementById('sfid_xdomain').contentWindow.postMessage);document.getElementById('sfid_xdomain').contentWindow.postMessage(JSON.stringify(requestObj),SFIDWidget.XAuthServerUrl);}functionqueueRequest(requestObj){if(unsupported){return;}requestObj.id=requestId;openRequests[requestId++]=requestObj;if(!iframe||!postWindow){requestQueue.push(requestObj.id);setupWindow();}else{makeRequest(requestObj);}}functioncallRetrieve(args){if(!args){args={};}varrequestObj={cmd:'xauth::retrieve',retrieve:args.retrieve||[SFIDWidget.config.communityURL],callback:args.callback||null}queueRequest(requestObj);}functioncallAlive(args){if(!args){args={};}varrequestObj={cmd:'xauth::alive',retrieve:args.retrieve||[SFIDWidget.config.communityURL],callback:args.callback||aliveCallback}queueRequest(requestObj);}functioncallExtend(args){if(!args){args={};}varrequestObj={cmd:'xauth::extend',token:args.token||'',expire:args.expire||0,extend:args.extend||[],session:args.session||false,callback:args.callback||null,communityURL:SFIDWidget.config.communityURL}queueRequest(requestObj);}functioncallExpire(args){if(!args){args={};}varrequestObj={cmd:'xauth::expire',callback:args.callback||null,communityURL:SFIDWidget.config.communityURL}queueRequest(requestObj);}functionaliveCallback(response){if((response.alive)&&(SFIDWidget.openid_response==null)){console.log('yougotloggedin');SFIDWidget.init();}elseif((!response.alive)&&(SFIDWidget.openid_response)){console.log('yougotloggedout');SFIDWidget.logout();}}functionsetup(response){vartokens=response.tokens;for(vardomainintokens){varencodedToken=tokens[domain]['token'];vardecodedToken=atob(encodedToken);SFIDWidget.openid_response=JSON.parse(decodedToken);}if(SFIDWidget.openid_response){window[SFIDWidget_loginHandler](SFIDWidget.openid_response);}else{if(SFIDWidget.config.mode=='popup'){vartargetDiv=document.querySelector(SFIDWidget.config.target);processConfig();}elseif((SFIDWidget.config.mode=='modal')||(SFIDWidget.config.mode=='inline')){if((sessionStorage.authconfig==null)||(sessionStorage.authconfig=='null')){varrequest=newXMLHttpRequest();request.onreadystatechange=function(){varDONE=this.DONE||4;if(this.readyState===DONE){SFIDWidget.authconfig=JSON.parse(this.responseText);sessionStorage.authconfig=btoa(JSON.stringify(SFIDWidget.authconfig));processConfig();}};request.open('GET',SFIDWidget.config.communityURL+'/.well-known/auth-configuration',true);request.send(null);}else{SFIDWidget.authconfig=JSON.parse(atob(sessionStorage.authconfig));processConfig();}}}setInterval("SFIDWidget.isAlive()",3000);}functionprocessConfig(){varstate='';if(SFIDWidget.config.mode=='popup'){state=encodeURIComponent(SFIDWidget_loginHandler);}else{state=(SFIDWidget.config.startURL?encodeURIComponent(SFIDWidget.config.startURL):'');}SFIDWidget.config.authorizeURL='/services/oauth2/authorize?response_type=token&client_id='+SFIDWidget.config.client_id+'&redirect_uri='+encodeURIComponent(SFIDWidget.config.redirect_uri)+'&state='+state;if(SFIDWidget.config.mode=='inline'){vartargetDiv=document.querySelector(SFIDWidget.config.target);addLogin(targetDiv);}else{vartargetDiv=document.querySelector(SFIDWidget.config.target);addButton(targetDiv);}}functionshowError(){vare=document.getElementById('sfid-error');e.style.display='inline';}functionhideError(){vare=document.getElementById('sfid-error');e.style.display='none';}varready=function(a,b,c){b=document,c='addEventListener';b[c]?b[c]('DOMContentLoaded',a):window.attachEvent('onload',a)}functionfetch(){SFIDWidget.getToken({callback:setup});}return{init:function(){SFIDWidget.config={};SFIDWidget.config.startURL=location.pathname+location.search;varnamespace=null;namespace=document.querySelector('meta[name="salesforce-namespace"]').content;if(namespace!=null){namespace=namespace+'/';}varcommunityURLTag=document.querySelector('meta[name="salesforce-community"]');if(communityURLTag==null){alert('Specifyameta-tagforsalesforce-community');return;}else{SFIDWidget.config.communityURL=communityURLTag.content;varrawDomain=SFIDWidget.config.communityURL.substring(8,SFIDWidget.config.communityURL.length);if(rawDomain.indexOf("/")>0)rawDomain=rawDomain.substring(0,rawDomain.indexOf('/'));SFIDWidget.config.domain=rawDomain;SFIDWidget.XAuthServerUrl=SFIDWidget.config.communityURL+"/services/apexrest/"+namespace+"xauth?community="+SFIDWidget.config.communityURL;}varmodeTag=document.querySelector('meta[name="salesforce-mode"]');if(modeTag==null){alert('Specifyameta-tagforsalesforce-mode');return;}else{SFIDWidget.config.mode=modeTag.content;if((SFIDWidget.config.mode=='popup-callback')||(SFIDWidget.config.mode=='modal-callback')||(SFIDWidget.config.mode=='inline-callback')){varallowedDomainsTag=document.querySelector('meta[name="salesforce-allowed-domains"]');if(allowedDomainsTag==null){alert('Specifyameta-tagforsalesforce-allowed-domains');}else{SFIDWidget.config.allowedDomains=allowedDomainsTag.content.split(',');}varsaveTokenTag=document.querySelector('meta[name="salesforce-save-access-token"]');if((saveTokenTag==null)||(saveTokenTag.content=='false')){SFIDWidget.config.saveToken=false;}elseif(saveTokenTag.content=='true'){SFIDWidget.config.saveToken=true;}SFIDWidget.handleLoginCallback();return;}}varclient_idTag=document.querySelector('meta[name="salesforce-client-id"]');if(client_idTag==null){alert('Specifyameta-tagforsalesforce-client-id');return;}else{SFIDWidget.config.client_id=client_idTag.content;}varredirect_uriTag=document.querySelector('meta[name="salesforce-redirect-uri"]');if(redirect_uriTag==null){alert('Specifyameta-tagforsalesforce-redirect-uri');return;}else{SFIDWidget.config.redirect_uri=redirect_uriTag.content;}vartargetTag=document.querySelector('meta[name="salesforce-target"]');if(targetTag==null){alert('Specifyameta-tagforsalesforce-target');return;}else{SFIDWidget.config.target=targetTag.content;}varloginHandlerTag=document.querySelector('meta[name="salesforce-login-handler"]');if(loginHandlerTag==null){alert('Specifyameta-tagforsalesforce-login-handler');return;}else{SFIDWidget_loginHandler=loginHandlerTag.content;}varlogoutHandlerTag=document.querySelector('meta[name="salesforce-logout-handler"]');if(logoutHandlerTag!=null){SFIDWidget_logoutHandler=logoutHandlerTag.content;}if((SFIDWidget.config.mode=='popup')||(SFIDWidget.config.mode=='modal')||(SFIDWidget.config.mode=='inline')){if(document.body==null){ready(function(){fetch();});}else{fetch();}}},login:function(){if(SFIDWidget.config!=null){if(SFIDWidget.config.mode=='popup'){varloginWindow=window.open(SFIDWidget.config.communityURL+SFIDWidget.config.authorizeURL,'LoginWindow','height=580,width=450');if(window.focus){loginWindow.focus()}returnfalse;}elseif(SFIDWidget.config.mode=='modal'){addLogin();}}},authenticate:function(){hideError();document.getElementById("sfid-submit").disabled=true;document.getElementById("sfid-submit").className='sfid-disabledsfid-widesfid-mb16';varun=document.getElementById('sfid-username').value;varpw=document.getElementById('sfid-password').value;if((un!=null)&&(un!='')&&(pw!=null)&&(pw!='')){varrequest=newXMLHttpRequest();request.open('POST',SFIDWidget.config.communityURL+'/loginservice',true);request.setRequestHeader("Content-type","application/x-www-form-urlencoded");request.onreadystatechange=function(){varDONE=this.DONE||4;if(this.readyState===DONE){varapiResponse=JSON.parse(this.responseText);if(apiResponse.result=='invalid'){showError();document.getElementById("sfid-submit").disabled=false;document.getElementById("sfid-submit").className='sfid-buttonsfid-widesfid-mb16';}else{varifrm=document.createElement('iframe');ifrm.setAttribute('src',apiResponse.result);ifrm.className='sfid-callback';ifrm.id='sfid-callback';document.body.appendChild(ifrm);}}};request.send('username='+un+'&password='+pw+'&startURL='+encodeURIComponent(SFIDWidget.config.authorizeURL));}else{showError();document.getElementById("sfid-submit").className='sfid-buttonsfid-widesfid-mb16';document.getElementById("sfid-submit").disabled=false;}},cancel:function(){closeLogin();},handleLoginCallback:function(){if(window.location.hash){varmessage=window.location.hash.substr(1);varnvps=message.split('&');for(varnvpinnvps){varparts=nvps[nvp].split('=');if(parts[0]=='id'){SFIDWidget.openid=decodeURIComponent(parts[1]);}elseif(parts[0]=='access_token'){SFIDWidget.access_token=parts[1];}elseif(parts[0]=='state'){if(parts[1]!=null)if(SFIDWidget.config.mode=='popup-callback'){if(parts[1]!=null)SFIDWidget_loginHandler=decodeURIComponent(parts[1]);}else{SFIDWidget.config.startURL=decodeURIComponent(parts[1]);}}}varopenidScript=document.createElement('script');openidScript.setAttribute('src',SFIDWidget.openid+'?version=latest&callback=SFIDWidget_handleOpenIDCallback&access_token='+SFIDWidget.access_token);document.head.appendChild(openidScript);}},redirectToStartURL:function(){if(SFIDWidget.config.mode=='popup-callback'){window.opener.SFIDWidget.openid_response=SFIDWidget.openid_response;window.opener[SFIDWidget_loginHandler](SFIDWidget.openid_response);window.close();}elseif((SFIDWidget.config.mode=='modal-callback')||(SFIDWidget.config.mode=='inline-callback')){if((SFIDWidget.config.startURL)&&(SFIDWidget.config.startURL.toLowerCase().indexOf('http')==0)){alert('YoumayonlyusepathsforyourstartURL.');returnnull;}else{if(self==top){window.location=SFIDWidget.config.startURL;}else{window.parent.SFIDWidget.openid_response=SFIDWidget.openid_response;window.parent.callLoginEvent();}}}},logout:function(){if(SFIDWidget.openid_response.access_token!=null){varrevokeURL=SFIDWidget.config.communityURL+'/services/oauth2/revoke?callback=SFIDWidget_handleRevokeCallback&token='+SFIDWidget.openid_response.access_token;varopenidScript=document.createElement('script');openidScript.setAttribute('src',revokeURL);document.head.appendChild(openidScript);}SFIDWidget.expireToken({callback:SFIDWidget_handleExpireCallback});varifrm=document.createElement('iframe');ifrm.setAttribute('src',SFIDWidget.config.communityURL+'/secur/logout.jsp');ifrm.className='sfid-logout';ifrm.onload=function(){this.parentNode.removeChild(this);console.log('idpsessionwasinvalidated');};document.body.appendChild(ifrm);},setToken:callExtend,getToken:callRetrieve,expireToken:callExpire,isAlive:callAlive,disabled:unsupported}}();functioncallLoginEvent(){window[SFIDWidget_loginHandler](SFIDWidget.openid_response);variframe=document.getElementById('sfid-callback');iframe.parentNode.removeChild(iframe);if(SFIDWidget.config.mode=='modal')SFIDWidget.cancel();}functionSFIDWidget_handleOpenIDCallback(response){SFIDWidget.openid_response=response;if(SFIDWidget.config.saveToken)SFIDWidget.openid_response.access_token=SFIDWidget.access_token;varencodedResponse=btoa(JSON.stringify(response));SFIDWidget.setToken({token:encodedResponse,expire:1589249349000,extend:SFIDWidget.config.allowedDomains,callback:SFIDWidget.redirectToStartURL,session:true});};functionSFIDWidget_handleRevokeCallback(response){if(response.error!=null){console.log('accesstokenwasalreadyinvalid');}else{console.log('accesstokenwasrevoked');}};functionSFIDWidget_handleExpireCallback(response){console.log('xauthtokenwasexpired:'+response);SFIDWidget.access_token=null;SFIDWidget.openid=null;SFIDWidget.openid_response=null;SFIDWidget.config=null;SFIDWidget.authconfig=null;window[SFIDWidget_logoutHandler]();};SFIDWidget.init();