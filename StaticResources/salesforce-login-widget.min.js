/*
	Copyright Salesforce.com 2015 
	Copyright 2010 Meebo Inc.

	Licensed under the Apache License, Version 2.0 (the "License");
	you may not use this file except in compliance with the License.
	You may obtain a copy of the License at

	    http://www.apache.org/licenses/LICENSE-2.0

	Unless required by applicable law or agreed to in writing, software
	distributed under the License is distributed on an "AS IS" BASIS,
	WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
	See the License for the specific language governing permissions and
	limitations under the License.
*/
var SFIDWidget_loginHandler;var SFIDWidget_logoutHandler;var SFIDWidget=function(){this.config=null;this.access_token=null;this.openid=null;this.openid_response=null;this.win=window;this.unsupported=!(win.postMessage&&win.localStorage&&win.JSON);this.XAuthServerUrl=null;this.iframe=null;this.postWindow=null;this.openRequests={};this.requestId=0;this.requestQueue=[];function n(u){u.innerHTML="";var t=document.createElement("button");t.className="sfid-button";t.innerHTML="Log in";t.setAttribute("onClick","SFIDWidget.login()");u.appendChild(t)}function i(y){if(y!=null){y.innerHTML=""}var D=document.createElement("div");if(SFIDWidget.config.mode=="modal"){D.id="sfid-content"}else{if(SFIDWidget.config.mode=="inline"){D.id="sfid-inline-content"}}if(SFIDWidget.config.mode=="modal"){if(SFIDWidget.authconfig.LoginPage.LogoUrl!=null){var I=document.createElement("div");I.id="sfid-logo_wrapper";I.className="sfid-standard_logo_wrapper sfid-mt12";var K=document.createElement("img");K.src=SFIDWidget.authconfig.LoginPage.LogoUrl;K.className="sfid-standard_logo";I.appendChild(K);D.appendChild(I)}}var C=document.createElement("div");C.className="sfid-mb1";C.id="sfid-error";C.innerHTML="Your login attempt has failed. Make sure the username and password are correct. ";C.style.display="none";D.appendChild(C);if(SFIDWidget.authconfig.LoginPage.UsernamePasswordEnabled){var u=document.createElement("form");u.setAttribute("onSubmit","SFIDWidget.authenticate();return false;");var A=document.createElement("input");A.className="sfid-wide sfid-mb12";A.type="text";A.name="username";A.id="sfid-username";A.setAttribute("placeholder","Username");var B=document.createElement("input");B.className="sfid-wide sfid-mb12";B.type="password";B.name="password";B.id="sfid-password";B.setAttribute("placeholder","Password");var t=document.createElement("input");t.className="sfid-button sfid-wide sfid-mb16";t.type="submit";t.id="sfid-submit";t.value="Log in";u.appendChild(A);u.appendChild(B);u.appendChild(t);D.appendChild(u)}if((SFIDWidget.authconfig.LoginPage.UsernamePasswordEnabled)&&(SFIDWidget.authconfig.AuthProviders.length>0)){var z=document.createElement("p");z.className="sfid-small sfid-mb16";z.innerHTML="or log in with";D.appendChild(z)}else{if((!SFIDWidget.authconfig.LoginPage.UsernamePasswordEnabled)&&(SFIDWidget.authconfig.AuthProviders.length>0)){var z=document.createElement("p");z.className="sfid-small sfid-mb16";z.innerHTML="Choose a Provider";D.appendChild(z)}}if(SFIDWidget.authconfig.AuthProviders.length>0){var w=document.createElement("div");w.id="sfid-social";var H=document.createElement("ul");for(var E in SFIDWidget.authconfig.AuthProviders){var G=document.createElement("li");var F=document.createElement("img");F.src=SFIDWidget.authconfig.AuthProviders[E].IconUrl;var J=document.createElement("a");J.href=SFIDWidget.authconfig.AuthProviders[E].SsoUrl+"&startURL="+encodeURIComponent(SFIDWidget.config.authorizeURL);J.appendChild(F);J.title=SFIDWidget.authconfig.AuthProviders[E].Name;G.appendChild(J);H.appendChild(G)}w.appendChild(H);D.appendChild(w)}if(SFIDWidget.config.mode=="modal"){var v=document.createElement("div");v.className="sfid-lightbox";v.id="sfid-login-overlay";v.setAttribute("onClick","SFIDWidget.cancel()");var x=document.createElement("div");x.id="sfid-wrapper";x.onclick=function(L){L=L||window.event;if(L.stopPropagation){L.stopPropagation()}else{L.cancelBubble=true}};x.appendChild(D);v.appendChild(x);document.body.appendChild(v)}else{y.appendChild(D)}}function b(){var t=document.getElementById("sfid-login-overlay");t.style.display="none";if(t.parentNode){t.parentNode.removeChild(t)}}function q(u){var w=u.origin.split("://")[1].split(":")[0];if(w!=SFIDWidget.config.domain){console.log("doesnt match domain: "+w+";"+SFIDWidget.config.domain);return}var v=JSON.parse(u.data);if(!v){return}if(v.cmd=="xauth::ready"){postWindow=iframe.contentWindow;setTimeout(f,0);return}var t=openRequests[v.id];if(t){if(t.callback){t.callback(v)}delete openRequests[v.id]}}function o(){if(iframe||postWindow){return}var u=win.document;iframe=u.createElement("iframe");iframe.id="sfid_xdomain";var t=iframe.style;t.position="absolute";t.left=t.top="-999px";if(win.addEventListener){win.addEventListener("message",q,false)}else{if(win.attachEvent){win.attachEvent("onmessage",q)}}u.body.appendChild(iframe);iframe.src=SFIDWidget.XAuthServerUrl}function f(){for(var t=0;t<requestQueue.length;t++){p(openRequests[requestQueue.shift()])}}function p(t){console.log(document.getElementById("sfid_xdomain").contentWindow.postMessage);document.getElementById("sfid_xdomain").contentWindow.postMessage(JSON.stringify(t),SFIDWidget.XAuthServerUrl)}function a(t){if(unsupported){return}t.id=requestId;openRequests[requestId++]=t;if(!iframe||!postWindow){requestQueue.push(t.id);o()}else{p(t)}}function g(t){if(!t){t={}}var u={cmd:"xauth::retrieve",retrieve:t.retrieve||[SFIDWidget.config.communityURL],callback:t.callback||null};a(u)}function k(t){if(!t){t={}}var u={cmd:"xauth::alive",retrieve:t.retrieve||[SFIDWidget.config.communityURL],callback:t.callback||j};a(u)}function s(t){if(!t){t={}}var u={cmd:"xauth::extend",token:t.token||"",expire:t.expire||0,extend:t.extend||[],session:t.session||false,callback:t.callback||null,communityURL:SFIDWidget.config.communityURL};a(u)}function r(t){if(!t){t={}}var u={cmd:"xauth::expire",callback:t.callback||null,communityURL:SFIDWidget.config.communityURL};a(u)}function j(t){if((t.alive)&&(SFIDWidget.openid_response==null)){console.log("you got logged in");SFIDWidget.init()}else{if((!t.alive)&&(SFIDWidget.openid_response)){console.log("you got logged out");SFIDWidget.logout()}}}function l(v){var z=v.tokens;for(var y in z){var u=z[y]["token"];var t=atob(u);SFIDWidget.openid_response=JSON.parse(t)}if(SFIDWidget.openid_response){window[SFIDWidget_loginHandler](SFIDWidget.openid_response)}else{if(SFIDWidget.config.mode=="popup"){var x=document.querySelector(SFIDWidget.config.target);c()}else{if((SFIDWidget.config.mode=="modal")||(SFIDWidget.config.mode=="inline")){if((sessionStorage.authconfig==null)||(sessionStorage.authconfig=="null")){var w=new XMLHttpRequest();w.onreadystatechange=function(){var A=this.DONE||4;if(this.readyState===A){SFIDWidget.authconfig=JSON.parse(this.responseText);sessionStorage.authconfig=btoa(JSON.stringify(SFIDWidget.authconfig));c()}};w.open("GET",SFIDWidget.config.communityURL+"/.well-known/auth-configuration",true);w.send(null)}else{SFIDWidget.authconfig=JSON.parse(atob(sessionStorage.authconfig));c()}}}}setInterval("SFIDWidget.isAlive()",3000)}function c(){var v="";if(SFIDWidget.config.mode=="popup"){v=encodeURIComponent(SFIDWidget_loginHandler)}else{v=(SFIDWidget.config.startURL?encodeURIComponent(SFIDWidget.config.startURL):"")}var t="token";if(SFIDWidget.config.serverCallback){t="code"}SFIDWidget.config.authorizeURL="/services/oauth2/authorize?response_type="+t+"&client_id="+SFIDWidget.config.client_id+"&redirect_uri="+encodeURIComponent(SFIDWidget.config.redirect_uri)+"&state="+v;if(SFIDWidget.config.mode=="inline"){var u=document.querySelector(SFIDWidget.config.target);i(u)}else{var u=document.querySelector(SFIDWidget.config.target);n(u)}}function d(){var t=document.getElementById("sfid-error");t.style.display="inline"}function e(){var t=document.getElementById("sfid-error");t.style.display="none"}var h=function(u,t,v){t=document,v="addEventListener";t[v]?t[v]("DOMContentLoaded",u):window.attachEvent("onload",u)};function m(){SFIDWidget.getToken({callback:l})}return{init:function(){SFIDWidget.config={};SFIDWidget.config.startURL=location.pathname+location.search;var y=null;var B=document.querySelector('meta[name="salesforce-namespace"]');if(B!=null&&B.content!=''){y=B.content+"/"}var w=document.querySelector('meta[name="salesforce-community"]');if(w==null){alert("Specify a meta-tag for salesforce-community");return}else{SFIDWidget.config.communityURL=w.content;var E=SFIDWidget.config.communityURL.substring(8,SFIDWidget.config.communityURL.length);if(E.indexOf("/")>0){E=E.substring(0,E.indexOf("/"))}SFIDWidget.config.domain=E;SFIDWidget.XAuthServerUrl=SFIDWidget.config.communityURL+"/services/apexrest/";if(y!=null){SFIDWidget.XAuthServerUrl+=y}SFIDWidget.XAuthServerUrl+="xauth?community="+SFIDWidget.config.communityURL}var D=document.querySelector('meta[name="salesforce-server-callback"]');if((D==null)||(D.content=="false")){SFIDWidget.config.serverCallback=false}else{if(D.content=="true"){SFIDWidget.config.serverCallback=true}}var v=document.querySelector('meta[name="salesforce-mode"]');if(v==null){alert("Specify a meta-tag for salesforce-mode");return}else{SFIDWidget.config.mode=v.content;if((SFIDWidget.config.mode=="popup-callback")||(SFIDWidget.config.mode=="modal-callback")||(SFIDWidget.config.mode=="inline-callback")){var z=document.querySelector('meta[name="salesforce-allowed-domains"]');if(z==null){alert("Specify a meta-tag for salesforce-allowed-domains")}else{SFIDWidget.config.allowedDomains=z.content.split(",")}var t=document.querySelector('meta[name="salesforce-save-access-token"]');if((t==null)||(t.content=="false")){SFIDWidget.config.saveToken=false}else{if(t.content=="true"){SFIDWidget.config.saveToken=true}}SFIDWidget.handleLoginCallback();return}}var A=document.querySelector('meta[name="salesforce-client-id"]');if(A==null){alert("Specify a meta-tag for salesforce-client-id");return}else{SFIDWidget.config.client_id=A.content}var C=document.querySelector('meta[name="salesforce-redirect-uri"]');if(C==null){alert("Specify a meta-tag for salesforce-redirect-uri");return}else{SFIDWidget.config.redirect_uri=C.content}var u=document.querySelector('meta[name="salesforce-target"]');if(u==null){alert("Specify a meta-tag for salesforce-target");return}else{SFIDWidget.config.target=u.content}var F=document.querySelector('meta[name="salesforce-login-handler"]');if(F==null){alert("Specify a meta-tag for salesforce-login-handler");return}else{SFIDWidget_loginHandler=F.content}var x=document.querySelector('meta[name="salesforce-logout-handler"]');if(x!=null){SFIDWidget_logoutHandler=x.content}if((SFIDWidget.config.mode=="popup")||(SFIDWidget.config.mode=="modal")||(SFIDWidget.config.mode=="inline")){if(document.body==null){h(function(){m()})}else{m()}}},login:function(){if(SFIDWidget.config!=null){if(SFIDWidget.config.mode=="popup"){var t=window.open(SFIDWidget.config.communityURL+SFIDWidget.config.authorizeURL,"Login Window","height=580,width=450");if(window.focus){t.focus()}return false}else{if(SFIDWidget.config.mode=="modal"){i()}}}},authenticate:function(){e();document.getElementById("sfid-submit").disabled=true;document.getElementById("sfid-submit").className="sfid-disabled sfid-wide sfid-mb16";var t=document.getElementById("sfid-username").value;var u=document.getElementById("sfid-password").value;if((t!=null)&&(t!="")&&(u!=null)&&(u!="")){var v=new XMLHttpRequest();v.open("POST",SFIDWidget.config.communityURL+"/loginservice",true);v.setRequestHeader("Content-type","application/x-www-form-urlencoded");v.onreadystatechange=function(){var y=this.DONE||4;if(this.readyState===y){var x=JSON.parse(this.responseText);if(x.result=="invalid"){d();document.getElementById("sfid-submit").disabled=false;document.getElementById("sfid-submit").className="sfid-button sfid-wide sfid-mb16"}else{var w=document.createElement("iframe");w.setAttribute("src",x.result);w.className="sfid-callback";w.id="sfid-callback";document.body.appendChild(w)}}};v.send("username="+t+"&password="+u+"&startURL="+encodeURIComponent(SFIDWidget.config.authorizeURL))}else{d();document.getElementById("sfid-submit").className="sfid-button sfid-wide sfid-mb16";document.getElementById("sfid-submit").disabled=false}},cancel:function(){b()},handleLoginCallback:function(){if(SFIDWidget.config.serverCallback){var v=document.querySelector('meta[name="salesforce-server-starturl"]');if(v==null){SFIDWidget.config.startURL="/"}else{SFIDWidget.config.startURL=v.content}var y=document.querySelector('meta[name="salesforce-server-response"]');if(y==null){alert("server callback didnt provide a response");return}else{SFIDWidget_handleOpenIDCallback(JSON.parse(y.content))}}else{if(window.location.hash){var w=window.location.hash.substr(1);var z=w.split("&");for(var u in z){var x=z[u].split("=");if(x[0]=="id"){SFIDWidget.openid=decodeURIComponent(x[1])}else{if(x[0]=="access_token"){SFIDWidget.access_token=x[1]}else{if(x[0]=="state"){if(x[1]!=null){if(SFIDWidget.config.mode=="popup-callback"){if(x[1]!=null){SFIDWidget_loginHandler=decodeURIComponent(x[1])}}else{SFIDWidget.config.startURL=decodeURIComponent(x[1])}}}}}}var t=document.createElement("script");t.setAttribute("src",SFIDWidget.openid+"?version=latest&callback=SFIDWidget_handleOpenIDCallback&format=jsonp&access_token="+SFIDWidget.access_token);document.head.appendChild(t)}}},redirectToStartURL:function(){if(SFIDWidget.config.mode=="popup-callback"){window.opener.SFIDWidget.openid_response=SFIDWidget.openid_response;window.opener[SFIDWidget_loginHandler](SFIDWidget.openid_response);window.close()}else{if((SFIDWidget.config.mode=="modal-callback")||(SFIDWidget.config.mode=="inline-callback")){if((SFIDWidget.config.startURL)&&(SFIDWidget.config.startURL.toLowerCase().indexOf("http")==0)){alert("You may only use paths for your startURL.");return null}else{if(self==top){window.location=SFIDWidget.config.startURL}else{window.parent.SFIDWidget.openid_response=SFIDWidget.openid_response;window.parent.callLoginEvent()}}}}},logout:function(){if(SFIDWidget.openid_response.access_token!=null){var v=SFIDWidget.config.communityURL+"/services/oauth2/revoke?callback=SFIDWidget_handleRevokeCallback&token="+SFIDWidget.openid_response.access_token;var u=document.createElement("script");u.setAttribute("src",v);document.head.appendChild(u)}SFIDWidget.expireToken({callback:SFIDWidget_handleExpireCallback});var t=document.createElement("iframe");t.setAttribute("src",SFIDWidget.config.communityURL+"/secur/logout.jsp");t.className="sfid-logout";t.onload=function(){this.parentNode.removeChild(this);console.log("idp session was invalidated")};document.body.appendChild(t)},setToken:s,getToken:g,expireToken:r,isAlive:k,disabled:unsupported}}();function callLoginEvent(){window[SFIDWidget_loginHandler](SFIDWidget.openid_response);var a=document.getElementById("sfid-callback");a.parentNode.removeChild(a);if(SFIDWidget.config.mode=="modal"){SFIDWidget.cancel()}}function SFIDWidget_handleOpenIDCallback(b){SFIDWidget.openid_response=b;console.log(SFIDWidget.openid_response);if((SFIDWidget.config.saveToken)&&(!SFIDWidget.config.serverCallback)){SFIDWidget.openid_response.access_token=SFIDWidget.access_token}var a=btoa(JSON.stringify(b));SFIDWidget.setToken({token:a,expire:1589249349000,extend:SFIDWidget.config.allowedDomains,callback:SFIDWidget.redirectToStartURL,session:true})}function SFIDWidget_handleRevokeCallback(a){if(a.error!=null){console.log("access token was already invalid")}else{console.log("access token was revoked")}}function SFIDWidget_handleExpireCallback(a){console.log("xauth token was expired: "+a);SFIDWidget.access_token=null;SFIDWidget.openid=null;SFIDWidget.openid_response=null;SFIDWidget.config=null;SFIDWidget.authconfig=null;window[SFIDWidget_logoutHandler]()}SFIDWidget.init();
